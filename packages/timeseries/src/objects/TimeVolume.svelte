<svelte:options immutable />

<script lang="ts">
    import { getContext, onMount } from "svelte";
    import type { Writable } from "svelte/store";
    import type { Viewport3D } from "lib-graphics";
    import { Volume } from "lib-graphics";
    import type { vec3, vec4 } from "gl-matrix";

    export let visible = true;
    export let radii: number[] = [];
    export let points: vec3[][][] | null = null;
    export let colors: vec4[];
    export let transparency: number = 1.0;
    export let colormap: ImageBitmap | null = null;
    export let func: number = 0;

    let device: Writable<GPUDevice> = getContext("device");
    let viewport: Writable<Viewport3D | null> = getContext("viewport");

    let object: Volume | null = null;
    let objectID: number | null = null;

    $: if ($viewport) {
        if (objectID) {
            $viewport.scene.removeObjectByID(objectID);
        }

        [object, objectID] = $viewport.scene.addObjectInstanced(Volume, points.length);
        object.setDirtyCPU();
    }

    $: if (object && colormap) {
        object.setColorMapFromBitmap(colormap);
        object.setDirtyCPU();
    }

    $: if (object && points) {
        object.fromPointArrays($device, points, radii);
        object.setDirtyCPU();
    }

    $: if (object && colors) {
        for (let i = 0; i < colors.length; i++) {
            object.setColor(colors[i], i);
            console.log("Blob " + i + ": " +colors[i]);
        }
        object.setDirtyCPU();
    }

    $: if (object) {
        object.visible = visible;
        object.setDirtyCPU();
    }

    $: if (object && transparency) {
        object.transparency = transparency;
        object.setDirtyCPU();
    }

    $: if (object) {
        object.func = func;
        object.setDirtyCPU();
    }

    onMount(() => {
        return () => {
            if ($viewport?.scene && objectID) {
                $viewport.scene.removeObjectByID(objectID);
            }
        };
    });
</script>
